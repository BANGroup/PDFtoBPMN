<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a365d">
    <title>BPMN Viewer - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫</title>
    <!-- bpmn-js styles -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-font/css/bpmn.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* iOS safe areas */
        @supports (padding: env(safe-area-inset-top)) {
            .header { padding-top: calc(12px + env(safe-area-inset-top)); }
            body { padding-bottom: env(safe-area-inset-bottom); }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f7fafc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .file-name {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .toolbar {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Mobile: larger touch targets */
        @media (max-width: 768px) {
            .btn { padding: 12px 16px; font-size: 1rem; min-height: 44px; }
            .btn-zoom { padding: 12px 14px; min-width: 44px; min-height: 44px; justify-content: center; }
            .header { padding: 8px 12px; flex-wrap: wrap; gap: 8px; }
            .header-left { flex: 1; min-width: 200px; }
            .toolbar { flex-wrap: wrap; justify-content: flex-end; }
            .file-name { font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .logo { font-size: 1rem; }
            .nav-bar { padding: 8px 12px; }
            .breadcrumb-item { padding: 6px 10px; font-size: 0.8rem; }
            .welcome h2 { font-size: 1.2rem; }
            .welcome p { font-size: 0.9rem; }
            .welcome .btn-open { padding: 14px 24px; }
        }
        
        /* iPad landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .btn { padding: 10px 14px; }
        }
        
        /* Hide drag text on mobile (drag doesn't work) */
        @media (pointer: coarse) {
            .welcome p:last-child { display: none; }
        }
        
        .btn-open { background: #4299e1; color: white; }
        .btn-open:hover { background: #3182ce; }
        
        .btn-save { background: #48bb78; color: white; }
        .btn-save:hover { background: #38a169; }
        .btn-save:disabled { background: #a0aec0; cursor: not-allowed; }
        
        .btn-zoom { background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; }
        .btn-zoom:hover { background: rgba(255,255,255,0.3); }
        
        /* Navigation */
        .nav-bar {
            background: white;
            padding: 8px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            padding: 4px 10px;
            background: #edf2f7;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .breadcrumb-item:hover { background: #e2e8f0; }
        .breadcrumb-item.active { background: #4299e1; color: white; }
        .breadcrumb-sep { color: #a0aec0; }
        
        /* Main */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            padding: 16px;
            flex-shrink: 0;
        }
        
        /* Hide sidebar on mobile by default */
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.open { transform: translateX(0); }
        }
        
        .sidebar h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #718096;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        
        .tree-item {
            padding: 6px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .tree-item:hover { background: #edf2f7; }
        
        /* Canvas */
        .canvas-container {
            flex: 1;
            position: relative;
            background: #f7fafc;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            touch-action: pan-x pan-y pinch-zoom;
        }
        
        /* Prevent text selection on touch */
        .canvas-container {
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Welcome screen */
        .welcome {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
        }
        
        .welcome h2 {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 16px;
        }
        
        .welcome p {
            color: #718096;
            margin-bottom: 24px;
        }
        
        .welcome .btn-open {
            font-size: 1.1rem;
            padding: 12px 24px;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success { background: #48bb78; }
        .notification.error { background: #f56565; }
        .notification.info { background: #4299e1; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Unsaved indicator */
        .unsaved-dot {
            width: 8px;
            height: 8px;
            background: #f6ad55;
            border-radius: 50%;
            display: none;
        }
        
        .unsaved-dot.visible { display: block; }
        
        /* Hide elements when no file loaded */
        .hidden { display: none !important; }
        
        /* Drop overlay */
        .drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(66, 153, 225, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .drop-message {
            font-size: 2rem;
            color: white;
            padding: 40px 60px;
            border: 4px dashed white;
            border-radius: 20px;
        }
        
        .canvas-container.dragover {
            background: #ebf8ff;
        }
    </style>
</head>
<body ondragover="event.preventDefault(); event.stopPropagation();" ondrop="handleDrop(event);">
    <header class="header">
        <div class="header-left">
            <div class="logo">
                üìä BPMN Viewer
            </div>
            <div class="file-name" id="fileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="unsaved-dot" id="unsavedDot" title="–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"></div>
        </div>
        <div class="toolbar">
            <button class="btn btn-open" onclick="openFile()" title="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª (Ctrl+O)">
                üìÇ –û—Ç–∫—Ä—ã—Ç—å
            </button>
            <button class="btn btn-save" id="btnSave" onclick="saveFile()" disabled title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Ctrl+S)">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="btn btn-save" onclick="saveFileAs()" disabled id="btnSaveAs" style="background: #38a169;" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫...">
                üì• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫
            </button>
            <span style="width: 1px; background: rgba(255,255,255,0.3); margin: 0 8px;"></span>
            <button class="btn btn-zoom" onclick="zoomOut()" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
            <button class="btn btn-zoom" onclick="resetZoom()" title="–ü–æ —Ä–∞–∑–º–µ—Ä—É">1:1</button>
            <button class="btn btn-zoom" onclick="zoomIn()" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
            <button class="btn btn-zoom" onclick="fitDiagram()" title="–í–ø–∏—Å–∞—Ç—å">‚ä°</button>
        </div>
    </header>
    
    <nav class="nav-bar hidden" id="navBar">
        <div class="breadcrumb" id="breadcrumb">
            <span class="breadcrumb-item active">–ì–ª–∞–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</span>
        </div>
    </nav>
    
    <main class="main">
        <aside class="sidebar hidden" id="sidebar">
            <h3>üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞</h3>
            <div id="processTree"></div>
        </aside>
        
        <div class="canvas-container">
            <div id="canvas"></div>
            
            <div class="welcome" id="welcome">
                <h2>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ BPMN —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</p>
                <button class="btn btn-open" onclick="openFile()">
                    üìÇ –û—Ç–∫—Ä—ã—Ç—å BPMN —Ñ–∞–π–ª
                </button>
                <p style="margin-top: 16px; font-size: 0.85rem; color: #a0aec0;">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .bpmn –∏ .xml
                </p>
            </div>
            
            <div class="drop-overlay hidden" id="dropOverlay">
                <div class="drop-message">
                    üì• –û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –∑–¥–µ—Å—å
                </div>
            </div>
        </div>
    </main>

    <!-- bpmn-js Modeler -->
    <script src="https://unpkg.com/bpmn-js@17.11.1/dist/bpmn-modeler.production.min.js"></script>
    
    <script>
        // Global drop handler (must be outside DOMContentLoaded)
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const overlay = document.getElementById('dropOverlay');
            if (overlay) overlay.classList.add('hidden');
            
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.bpmn') || file.name.endsWith('.xml'))) {
                try {
                    const content = await file.text();
                    if (typeof loadBpmnContent === 'function') {
                        await loadBpmnContent(content, file.name);
                    } else {
                        alert('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞: ' + err.message);
                }
            } else if (file) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ .bpmn –∏–ª–∏ .xml —Ñ–∞–π–ª');
            }
        }

        let modeler = null;
        let fileHandle = null;
        
        let hasUnsavedChanges = false;
        let navigationStack = [];
        
        // Initialize modeler
        document.addEventListener('DOMContentLoaded', async () => {
            modeler = new BpmnJS({
                container: '#canvas',
                keyboard: { bindTo: document }
            });
            
            
            
            // Track changes
            modeler.on('commandStack.changed', () => {
                markAsUnsaved();
            });
            
            // Double-click to drill down
            modeler.on('element.dblclick', (e) => {
                if (e.element.type === 'bpmn:SubProcess') {
                    drillDown(e.element.id);
                }
            });
            
            // Drag & drop support
            // Prevent default drag behavior on window (prevents file opening)
            window.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            
            window.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            
            // Custom drag & drop for canvas area
            const dropZone = document.body;
            
            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropOverlay').classList.remove('hidden');
            });
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Only hide if leaving the document
                if (e.relatedTarget === null || !document.body.contains(e.relatedTarget)) {
                    document.getElementById('dropOverlay').classList.add('hidden');
                }
            });
            
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropOverlay').classList.add('hidden');
                
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.bpmn') || file.name.endsWith('.xml'))) {
                    try {
                        const content = await file.text();
                        await loadBpmnContent(content, file.name);
                    } catch (err) {
                        showNotification('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message, 'error');
                    }
                } else {
                    showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ .bpmn –∏–ª–∏ .xml —Ñ–∞–π–ª', 'error');
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'o') {
                        e.preventDefault();
                        openFile();
                    } else if (e.key === 's') {
                        e.preventDefault();
                        saveFile();
                    }
                }
                if (e.key === 'Escape') {
                    goBack();
                }
            });
        });
        
        // Open file
        // Build process tree in sidebar
        function buildProcessTree() {
            const tree = document.getElementById('processTree');
            const elementRegistry = modeler.get('elementRegistry');
            
            const subprocesses = elementRegistry.filter(el => el.type === 'bpmn:SubProcess');
            
            if (subprocesses.length === 0) {
                tree.innerHTML = '<div style="color: #a0aec0; font-size: 0.8rem;">–ù–µ—Ç –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</div>';
                return;
            }
            
            let html = '';
            subprocesses.forEach(sp => {
                const name = sp.businessObject.name || sp.id;
                html += '<div class="tree-item" onclick="drillDown(\''+sp.id+'\')">';
                html += 'üì¶ ' + name;
                html += '</div>';
            });
            
            tree.innerHTML = html;
        }
        
        // Load BPMN content (used by both drag-drop and file picker)
        async function loadBpmnContent(content, name) {
            try {
                await modeler.importXML(content);
                
                // Update UI
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('navBar').classList.remove('hidden');
                
                document.getElementById('fileName').textContent = name;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSaveAs').disabled = false;
                
                // Reset navigation
                navigationStack = [];
                updateBreadcrumb();
                
                fitDiagram();
                markAsSaved();
                
                showNotification('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: ' + name, 'success');
                
            } catch (err) {
                console.error('Load error:', err);
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
            }
        }
        
        async function openFile() {
            try {
                const options = {
                    types: [{
                        description: 'BPMN Files',
                        accept: { 'application/xml': ['.bpmn', '.xml'] }
                    }]
                };
                
                const [handle] = await window.showOpenFilePicker(options);
                
                fileHandle = handle;
                const file = await handle.getFile();
                const content = await file.text();
                
                await modeler.importXML(content);
                
                // Update UI
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('navBar').classList.remove('hidden');
                // sidebar removed
                // buildProcessTree removed
                
                document.getElementById('fileName').textContent = handle.name;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSaveAs').disabled = false;
                
                // Reset navigation
                navigationStack = [];
                updateBreadcrumb();
                
                fitDiagram();
                markAsSaved();
                
                showNotification('‚úÖ –û—Ç–∫—Ä—ã—Ç: ' + handle.name, 'success');
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
        
        // Save file
        async function saveFile() {
            try {
                const result = await modeler.saveXML({ format: true });
                
                // If no fileHandle, ask user to pick save location
                if (!fileHandle) {
                    const fileName = document.getElementById('fileName').textContent || 'diagram.bpmn';
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'BPMN Files',
                            accept: { 'application/xml': ['.bpmn'] }
                        }]
                    });
                }
                
                const writable = await fileHandle.createWritable();
                await writable.write(result.xml);
                await writable.close();
                
                // Update filename in header
                document.getElementById('fileName').textContent = fileHandle.name;
                
                markAsSaved();
                showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + fileHandle.name, 'success');
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
        
        // Save As (always shows picker)
        async function saveFileAs() {
            try {
                const result = await modeler.saveXML({ format: true });
                const fileName = document.getElementById('fileName').textContent || 'diagram.bpmn';
                
                const newHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'BPMN Files',
                        accept: { 'application/xml': ['.bpmn'] }
                    }]
                });
                
                const writable = await newHandle.createWritable();
                await writable.write(result.xml);
                await writable.close();
                
                // Update to new file
                fileHandle = newHandle;
                document.getElementById('fileName').textContent = newHandle.name;
                
                markAsSaved();
                showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫: ' + newHandle.name, 'success');
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
        
        // Drill down into subprocess
        function drillDown(elementId) {
            const canvas = modeler.get('canvas');
            const elementRegistry = modeler.get('elementRegistry');
            const element = elementRegistry.get(elementId);
            
            if (element && element.type === 'bpmn:SubProcess') {
                navigationStack.push({
                    id: canvas.getRootElement().id,
                    name: getCurrentPlaneName()
                });
                
                canvas.setRootElement(canvas.findRoot(elementId) || canvas.addRootElement({
                    id: elementId + '_plane',
                    bpmnElement: element.businessObject
                }));
                
                updateBreadcrumb();
                
                fitDiagram();
            }
        }
        
        // Go back
        function goBack() {
            if (navigationStack.length > 0) {
                const prev = navigationStack.pop();
                const canvas = modeler.get('canvas');
                const root = canvas.findRoot(prev.id);
                if (root) {
                    canvas.setRootElement(root);
                }
                updateBreadcrumb();
                
                fitDiagram();
            }
        }
        
        // Go to root
        function goToRoot() {
            const canvas = modeler.get('canvas');
            const definitions = modeler.getDefinitions();
            
            if (definitions) {
                const rootElements = definitions.rootElements || [];
                for (const el of rootElements) {
                    if (el.$type === 'bpmn:Process' || el.$type === 'bpmn:Collaboration') {
                        const root = canvas.findRoot(el.id);
                        if (root) {
                            canvas.setRootElement(root);
                            break;
                        }
                    }
                }
            }
            
            navigationStack = [];
            updateBreadcrumb();
            
            fitDiagram();
        }
        
        // Get current plane name
        function getCurrentPlaneName() {
            const canvas = modeler.get('canvas');
            const root = canvas.getRootElement();
            if (root && root.businessObject) {
                return root.businessObject.name || root.id;
            }
            return '–î–∏–∞–≥—Ä–∞–º–º–∞';
        }
        
        // Update breadcrumb
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item' + (navigationStack.length === 0 ? ' active' : '') + '" onclick="goToRoot()">üè† –ì–ª–∞–≤–Ω–∞—è</span>';
            
            navigationStack.forEach((item, idx) => {
                html += '<span class="breadcrumb-sep">‚Ä∫</span>';
                html += '<span class="breadcrumb-item" onclick="goToLevel(' + idx + ')">' + item.name + '</span>';
            });
            
            if (navigationStack.length > 0) {
                html += '<span class="breadcrumb-sep">‚Ä∫</span>';
                html += '<span class="breadcrumb-item active">' + getCurrentPlaneName() + '</span>';
            }
            
            breadcrumb.innerHTML = html;
        }
        
        // Go to specific level
        function goToLevel(idx) {
            while (navigationStack.length > idx + 1) {
                goBack();
            }
            goBack();
        }
        
        // Zoom functions
        function zoomIn() {
            modeler.get('zoomScroll').stepZoom(1);
        }
        
        function zoomOut() {
            modeler.get('zoomScroll').stepZoom(-1);
        }
        
        function resetZoom() {
            modeler.get('canvas').zoom(1);
        }
        
        function fitDiagram() {
            modeler.get('canvas').zoom('fit-viewport', 'auto');
        }
        
        // Change tracking
        function markAsUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedDot').classList.add('visible');
            document.title = '‚óè BPMN Viewer';
        }
        
        function markAsSaved() {
            hasUnsavedChanges = false;
            document.getElementById('unsavedDot').classList.remove('visible');
            document.title = 'BPMN Viewer';
        }
        
        // Notifications
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notif = document.createElement('div');
            notif.className = 'notification ' + type;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.remove(), 3000);
        }
        
        // Warn before leaving with unsaved changes
        window.onbeforeunload = (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        };
    </script>
</body>
</html>