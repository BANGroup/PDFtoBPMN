<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a365d">
    <title>BPMN Viewer - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫</title>
    <!-- bpmn-js styles -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-font/css/bpmn.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* iOS safe areas */
        @supports (padding: env(safe-area-inset-top)) {
            .header { padding-top: calc(12px + env(safe-area-inset-top)); }
            body { padding-bottom: env(safe-area-inset-bottom); }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f7fafc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .file-name {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .toolbar {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Mobile: larger touch targets */
        @media (max-width: 768px) {
            .btn { padding: 12px 16px; font-size: 1rem; min-height: 44px; }
            .btn-zoom { padding: 12px 14px; min-width: 44px; min-height: 44px; justify-content: center; }
            .header { padding: 8px 12px; flex-wrap: wrap; gap: 8px; }
            .header-left { flex: 1; min-width: 200px; }
            .toolbar { flex-wrap: wrap; justify-content: flex-end; }
            .file-name { font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .logo { font-size: 1rem; }
            .nav-bar { padding: 8px 12px; }
            .breadcrumb-item { padding: 6px 10px; font-size: 0.8rem; }
            .welcome h2 { font-size: 1.2rem; }
            .welcome p { font-size: 0.9rem; }
            .welcome .btn-open { padding: 14px 24px; }
        }
        
        /* iPad landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .btn { padding: 10px 14px; }
        }
        
        /* Hide drag text on mobile (drag doesn't work) */
        @media (pointer: coarse) {
            .welcome p:last-child { display: none; }
        }
        
        .btn-open { background: #4299e1; color: white; }
        .btn-open:hover { background: #3182ce; }
        
        .btn-save { background: #48bb78; color: white; }
        .btn-save:hover { background: #38a169; }
        .btn-save:disabled { background: #a0aec0; cursor: not-allowed; }
        
        .btn-zoom { background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; }
        .btn-zoom:hover { background: rgba(255,255,255,0.3); }
        
        /* Navigation */
        .nav-bar {
            background: white;
            padding: 8px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            padding: 4px 10px;
            background: #edf2f7;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .breadcrumb-item:hover { background: #e2e8f0; }
        .breadcrumb-item.active { background: #4299e1; color: white; }
        .breadcrumb-sep { color: #a0aec0; }
        
        /* Main */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            padding: 16px;
            flex-shrink: 0;
        }
        
        /* Hide sidebar on mobile by default */
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.open { transform: translateX(0); }
        }
        
        .sidebar h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #718096;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        
        .tree-item {
            padding: 6px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .tree-item:hover { background: #edf2f7; }
        
        /* Canvas */
        .canvas-container {
            flex: 1;
            position: relative;
            background: #f7fafc;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            touch-action: pan-x pan-y pinch-zoom;
        }
        
        /* Prevent text selection on touch */
        .canvas-container {
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Welcome screen */
        .welcome {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
        }
        
        .welcome h2 {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 16px;
        }
        
        .welcome p {
            color: #718096;
            margin-bottom: 24px;
        }
        
        .welcome .btn-open {
            font-size: 1.1rem;
            padding: 12px 24px;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success { background: #48bb78; }
        .notification.error { background: #f56565; }
        .notification.info { background: #4299e1; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Unsaved indicator */
        .unsaved-dot {
            width: 8px;
            height: 8px;
            background: #f6ad55;
            border-radius: 50%;
            display: none;
        }
        
        .unsaved-dot.visible { display: block; }
        
        /* Hide elements when no file loaded */
        .hidden { display: none !important; }
        
        /* Drop overlay */
        .drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(66, 153, 225, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .drop-message {
            font-size: 2rem;
            color: white;
            padding: 40px 60px;
            border: 4px dashed white;
            border-radius: 20px;
        }
        
        .canvas-container.dragover {
            background: #ebf8ff;
        }
        
        /* Info Panel (right sidebar) */
        .info-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            padding: 0;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, width 0.3s ease;
        }
        
        .info-panel.collapsed {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        
        .info-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-panel-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0;
        }
        
        .info-panel-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-panel-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .info-panel-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #718096;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-value {
            font-size: 0.9rem;
            color: #2d3748;
            line-height: 1.5;
        }
        
        .info-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #edf2f7;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #4a5568;
        }
        
        .info-badge.type-task { background: #bee3f8; color: #2b6cb0; }
        .info-badge.type-gateway { background: #faf089; color: #975a16; }
        .info-badge.type-event { background: #c6f6d5; color: #276749; }
        .info-badge.type-subprocess { background: #e9d8fd; color: #553c9a; }
        
        .info-quote {
            background: #f7fafc;
            border-left: 3px solid #667eea;
            padding: 12px;
            font-size: 0.85rem;
            color: #4a5568;
            font-style: italic;
            line-height: 1.6;
            margin-top: 8px;
        }
        
        .info-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #4299e1;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 6px 12px;
            background: #ebf8ff;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
        }
        
        .info-link:hover {
            background: #bee3f8;
        }
        
        .info-empty {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
        }
        
        .info-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        
        /* Toggle button for info panel */
        .btn-info {
            background: #667eea;
            color: white;
        }
        
        .btn-info:hover {
            background: #5a67d8;
        }
        
        .btn-info.active {
            background: #553c9a;
        }
        
        /* Mobile: info panel as overlay */
        @media (max-width: 768px) {
            .info-panel {
                position: fixed;
                right: 0;
                top: 0;
                bottom: 0;
                z-index: 200;
                width: 85%;
                max-width: 320px;
                transform: translateX(100%);
                box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            }
            .info-panel.open {
                transform: translateX(0);
            }
            .info-panel.collapsed {
                transform: translateX(100%);
                width: 85%;
            }
        }
        
        /* Traceability JSON loader */
        .trace-loaded {
            background: #c6f6d5;
            color: #276749;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
    </style>
</head>
<body ondragover="event.preventDefault(); event.stopPropagation();" ondrop="handleDrop(event);">
    <header class="header">
        <div class="header-left">
            <div class="logo">
                üìä BPMN Viewer
            </div>
            <div class="file-name" id="fileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="unsaved-dot" id="unsavedDot" title="–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"></div>
        </div>
        <div class="toolbar">
            <button class="btn btn-open" onclick="openFile()" title="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª (Ctrl+O)">
                üìÇ –û—Ç–∫—Ä—ã—Ç—å
            </button>
            <button class="btn btn-save" id="btnSave" onclick="saveFile()" disabled title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Ctrl+S)">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="btn btn-save" onclick="saveFileAs()" disabled id="btnSaveAs" style="background: #38a169;" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫...">
                üì• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫
            </button>
            <span style="width: 1px; background: rgba(255,255,255,0.3); margin: 0 8px;"></span>
            <button class="btn btn-zoom" onclick="zoomOut()" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
            <button class="btn btn-zoom" onclick="resetZoom()" title="–ü–æ —Ä–∞–∑–º–µ—Ä—É">1:1</button>
            <button class="btn btn-zoom" onclick="zoomIn()" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
            <button class="btn btn-zoom" onclick="fitDiagram()" title="–í–ø–∏—Å–∞—Ç—å">‚ä°</button>
            <span style="width: 1px; background: rgba(255,255,255,0.3); margin: 0 8px;"></span>
            <button class="btn btn-info" id="btnInfo" onclick="toggleInfoPanel()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ (I)">
                üìÑ –ò–Ω—Ñ–æ
            </button>
            <span class="trace-loaded hidden" id="traceLoaded">‚úì –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞</span>
        </div>
    </header>
    
    <nav class="nav-bar hidden" id="navBar">
        <div class="breadcrumb" id="breadcrumb">
            <span class="breadcrumb-item active">–ì–ª–∞–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</span>
        </div>
    </nav>
    
    <main class="main">
        <aside class="sidebar hidden" id="sidebar">
            <h3>üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞</h3>
            <div id="processTree"></div>
        </aside>
        
        <div class="canvas-container">
            <div id="canvas"></div>
            
            <div class="welcome" id="welcome">
                <h2>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ BPMN —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</p>
                <button class="btn btn-open" onclick="openFile()">
                    üìÇ –û—Ç–∫—Ä—ã—Ç—å BPMN —Ñ–∞–π–ª
                </button>
                <p style="margin-top: 16px; font-size: 0.85rem; color: #a0aec0;">
                    –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                </p>
            </div>
            
            <div class="drop-overlay hidden" id="dropOverlay">
                <div class="drop-message">
                    üì• –û—Ç–ø—É—Å—Ç–∏—Ç–µ BPMN —Ñ–∞–π–ª –∑–¥–µ—Å—å
                </div>
            </div>
        </div>
        
        <!-- Info Panel (right sidebar) -->
        <aside class="info-panel collapsed" id="infoPanel">
            <div class="info-panel-header">
                <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ</h3>
                <button class="info-panel-close" onclick="toggleInfoPanel()">√ó</button>
            </div>
            <div class="info-panel-content" id="infoPanelContent">
                <div class="info-empty">
                    <div class="info-empty-icon">üëÜ</div>
                    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç<br>–¥–∏–∞–≥—Ä–∞–º–º—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞<br>–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>
                </div>
            </div>
        </aside>
    </main>

    <!-- bpmn-js Modeler -->
    <script src="https://unpkg.com/bpmn-js@17.11.1/dist/bpmn-modeler.production.min.js"></script>
    
    <script>
        // Global drop handler (must be outside DOMContentLoaded)
        // Supports multiple files: .bpmn + .json together
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const overlay = document.getElementById('dropOverlay');
            if (overlay) overlay.classList.add('hidden');
            
            const files = Array.from(e.dataTransfer.files);
            
            // Find BPMN and JSON files
            const bpmnFile = files.find(f => f.name.endsWith('.bpmn') || f.name.endsWith('.xml'));
            const jsonFile = files.find(f => f.name.endsWith('.json'));
            
            if (bpmnFile) {
                try {
                    const bpmnContent = await bpmnFile.text();
                    
                    // If JSON file is also provided, load it first
                    if (jsonFile) {
                        try {
                            const jsonContent = await jsonFile.text();
                            if (typeof loadTraceabilityContent === 'function') {
                                loadTraceabilityContent(jsonContent, jsonFile.name);
                            }
                        } catch (jsonErr) {
                            console.warn('Traceability JSON error:', jsonErr);
                        }
                    }
                    
                    if (typeof loadBpmnContent === 'function') {
                        await loadBpmnContent(bpmnContent, bpmnFile.name);
                    } else {
                        alert('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞: ' + err.message);
                }
            } else if (jsonFile && !bpmnFile) {
                // Only JSON dropped - load as traceability
                try {
                    const jsonContent = await jsonFile.text();
                    if (typeof loadTraceabilityContent === 'function') {
                        loadTraceabilityContent(jsonContent, jsonFile.name);
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ JSON: ' + err.message);
                }
            } else if (files.length > 0) {
                alert('–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .bpmn —Ñ–∞–π–ª (–º–æ–∂–Ω–æ –≤–º–µ—Å—Ç–µ —Å .json —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π)');
            }
        }

        let modeler = null;
        let fileHandle = null;
        
        let hasUnsavedChanges = false;
        let navigationStack = [];
        let traceabilityData = null;  // External JSON traceability data
        let infoPanelOpen = false;
        
        // Initialize modeler
        document.addEventListener('DOMContentLoaded', async () => {
            modeler = new BpmnJS({
                container: '#canvas',
                keyboard: { bindTo: document }
            });
            
            
            
            // Track changes
            modeler.on('commandStack.changed', () => {
                markAsUnsaved();
            });
            
            // Double-click to drill down
            modeler.on('element.dblclick', (e) => {
                if (e.element.type === 'bpmn:SubProcess') {
                    drillDown(e.element.id);
                }
            });
            
            // Single click to show element info
            modeler.on('element.click', (e) => {
                const element = e.element;
                // Ignore clicks on root/canvas
                if (element.type === 'bpmn:Process' || element.type === 'bpmn:Collaboration' || !element.businessObject) {
                    return;
                }
                showElementInfo(element);
            });
            
            // Drag & drop support
            // Prevent default drag behavior on window (prevents file opening)
            window.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            
            window.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            
            // Custom drag & drop for canvas area
            const dropZone = document.body;
            
            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropOverlay').classList.remove('hidden');
            });
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Only hide if leaving the document
                if (e.relatedTarget === null || !document.body.contains(e.relatedTarget)) {
                    document.getElementById('dropOverlay').classList.add('hidden');
                }
            });
            
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropOverlay').classList.add('hidden');
                
                const files = Array.from(e.dataTransfer.files);
                const bpmnFile = files.find(f => f.name.endsWith('.bpmn') || f.name.endsWith('.xml'));
                const jsonFile = files.find(f => f.name.endsWith('.json'));
                
                if (bpmnFile) {
                    try {
                        // Load JSON first if provided
                        if (jsonFile) {
                            try {
                                const jsonContent = await jsonFile.text();
                                loadTraceabilityContent(jsonContent, jsonFile.name);
                            } catch (jsonErr) {
                                console.warn('JSON error:', jsonErr);
                            }
                        }
                        
                        const content = await bpmnFile.text();
                        await loadBpmnContent(content, bpmnFile.name);
                    } catch (err) {
                        showNotification('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message, 'error');
                    }
                } else if (jsonFile) {
                    // Only JSON - load traceability
                    try {
                        const jsonContent = await jsonFile.text();
                        loadTraceabilityContent(jsonContent, jsonFile.name);
                    } catch (err) {
                        showNotification('‚ùå –û—à–∏–±–∫–∞ JSON: ' + err.message, 'error');
                    }
                } else {
                    showNotification('‚ö†Ô∏è –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .bpmn + .json —Ñ–∞–π–ª—ã', 'error');
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'o') {
                        e.preventDefault();
                        openFile();
                    } else if (e.key === 's') {
                        e.preventDefault();
                        saveFile();
                    }
                }
                if (e.key === 'Escape') {
                    if (infoPanelOpen) {
                        toggleInfoPanel();
                    } else {
                        goBack();
                    }
                }
                if (e.key === 'i' || e.key === 'I' || e.key === '—à' || e.key === '–®') {
                    toggleInfoPanel();
                }
            });
        });
        
        // Open file
        // Build process tree in sidebar
        function buildProcessTree() {
            const tree = document.getElementById('processTree');
            const elementRegistry = modeler.get('elementRegistry');
            
            const subprocesses = elementRegistry.filter(el => el.type === 'bpmn:SubProcess');
            
            if (subprocesses.length === 0) {
                tree.innerHTML = '<div style="color: #a0aec0; font-size: 0.8rem;">–ù–µ—Ç –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</div>';
                return;
            }
            
            let html = '';
            subprocesses.forEach(sp => {
                const name = sp.businessObject.name || sp.id;
                html += '<div class="tree-item" onclick="drillDown(\''+sp.id+'\')">';
                html += 'üì¶ ' + name;
                html += '</div>';
            });
            
            tree.innerHTML = html;
        }
        
        // Load BPMN content (used by both drag-drop and file picker)
        async function loadBpmnContent(content, name) {
            try {
                // Check for embedded traceability in BPMN file
                const embedded = extractEmbeddedTraceability(content);
                if (embedded && !traceabilityData) {
                    traceabilityData = embedded;
                    document.getElementById('traceLoaded').classList.remove('hidden');
                    const count = Object.keys(embedded.elements || {}).length;
                    showNotification('üìé –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞: ' + count + ' —ç–ª–µ–º–µ–Ω—Ç–æ–≤', 'info');
                }
                
                await modeler.importXML(content);
                
                // Update UI
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('navBar').classList.remove('hidden');
                
                document.getElementById('fileName').textContent = name;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSaveAs').disabled = false;
                
                // Reset navigation
                navigationStack = [];
                updateBreadcrumb();
                
                fitDiagram();
                markAsSaved();
                
                showNotification('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: ' + name, 'success');
                
            } catch (err) {
                console.error('Load error:', err);
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
            }
        }
        
        async function openFile() {
            try {
                const options = {
                    types: [{
                        description: 'BPMN Files',
                        accept: { 'application/xml': ['.bpmn', '.xml'] }
                    }]
                };
                
                const [handle] = await window.showOpenFilePicker(options);
                
                fileHandle = handle;
                const file = await handle.getFile();
                const content = await file.text();
                
                await modeler.importXML(content);
                
                // Update UI
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('navBar').classList.remove('hidden');
                // sidebar removed
                // buildProcessTree removed
                
                document.getElementById('fileName').textContent = handle.name;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSaveAs').disabled = false;
                
                // Reset navigation
                navigationStack = [];
                updateBreadcrumb();
                
                fitDiagram();
                markAsSaved();
                
                showNotification('‚úÖ –û—Ç–∫—Ä—ã—Ç: ' + handle.name, 'success');
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
        
        // Save file
        async function saveFile() {
            try {
                const result = await modeler.saveXML({ format: true });
                
                // If no fileHandle, ask user to pick save location
                if (!fileHandle) {
                    const fileName = document.getElementById('fileName').textContent || 'diagram.bpmn';
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'BPMN Files',
                            accept: { 'application/xml': ['.bpmn'] }
                        }]
                    });
                }
                
                const writable = await fileHandle.createWritable();
                await writable.write(result.xml);
                await writable.close();
                
                // Update filename in header
                document.getElementById('fileName').textContent = fileHandle.name;
                
                markAsSaved();
                showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + fileHandle.name, 'success');
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
        
        // Save As (always shows picker)
        async function saveFileAs() {
            try {
                const result = await modeler.saveXML({ format: true });
                const fileName = document.getElementById('fileName').textContent || 'diagram.bpmn';
                
                const newHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'BPMN Files',
                        accept: { 'application/xml': ['.bpmn'] }
                    }]
                });
                
                const writable = await newHandle.createWritable();
                await writable.write(result.xml);
                await writable.close();
                
                // Update to new file
                fileHandle = newHandle;
                document.getElementById('fileName').textContent = newHandle.name;
                
                markAsSaved();
                showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫: ' + newHandle.name, 'success');
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
        
        // Drill down into subprocess
        function drillDown(elementId) {
            const canvas = modeler.get('canvas');
            const elementRegistry = modeler.get('elementRegistry');
            const element = elementRegistry.get(elementId);
            
            if (element && element.type === 'bpmn:SubProcess') {
                navigationStack.push({
                    id: canvas.getRootElement().id,
                    name: getCurrentPlaneName()
                });
                
                canvas.setRootElement(canvas.findRoot(elementId) || canvas.addRootElement({
                    id: elementId + '_plane',
                    bpmnElement: element.businessObject
                }));
                
                updateBreadcrumb();
                
                fitDiagram();
            }
        }
        
        // Go back
        function goBack() {
            if (navigationStack.length > 0) {
                const prev = navigationStack.pop();
                const canvas = modeler.get('canvas');
                const root = canvas.findRoot(prev.id);
                if (root) {
                    canvas.setRootElement(root);
                }
                updateBreadcrumb();
                
                fitDiagram();
            }
        }
        
        // Go to root
        function goToRoot() {
            const canvas = modeler.get('canvas');
            const definitions = modeler.getDefinitions();
            
            if (definitions) {
                const rootElements = definitions.rootElements || [];
                for (const el of rootElements) {
                    if (el.$type === 'bpmn:Process' || el.$type === 'bpmn:Collaboration') {
                        const root = canvas.findRoot(el.id);
                        if (root) {
                            canvas.setRootElement(root);
                            break;
                        }
                    }
                }
            }
            
            navigationStack = [];
            updateBreadcrumb();
            
            fitDiagram();
        }
        
        // Get current plane name
        function getCurrentPlaneName() {
            const canvas = modeler.get('canvas');
            const root = canvas.getRootElement();
            if (root && root.businessObject) {
                return root.businessObject.name || root.id;
            }
            return '–î–∏–∞–≥—Ä–∞–º–º–∞';
        }
        
        // Update breadcrumb
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item' + (navigationStack.length === 0 ? ' active' : '') + '" onclick="goToRoot()">üè† –ì–ª–∞–≤–Ω–∞—è</span>';
            
            navigationStack.forEach((item, idx) => {
                html += '<span class="breadcrumb-sep">‚Ä∫</span>';
                html += '<span class="breadcrumb-item" onclick="goToLevel(' + idx + ')">' + item.name + '</span>';
            });
            
            if (navigationStack.length > 0) {
                html += '<span class="breadcrumb-sep">‚Ä∫</span>';
                html += '<span class="breadcrumb-item active">' + getCurrentPlaneName() + '</span>';
            }
            
            breadcrumb.innerHTML = html;
        }
        
        // Go to specific level
        function goToLevel(idx) {
            while (navigationStack.length > idx + 1) {
                goBack();
            }
            goBack();
        }
        
        // Zoom functions
        function zoomIn() {
            modeler.get('zoomScroll').stepZoom(1);
        }
        
        function zoomOut() {
            modeler.get('zoomScroll').stepZoom(-1);
        }
        
        function resetZoom() {
            modeler.get('canvas').zoom(1);
        }
        
        function fitDiagram() {
            modeler.get('canvas').zoom('fit-viewport', 'auto');
        }
        
        // Change tracking
        function markAsUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedDot').classList.add('visible');
            document.title = '‚óè BPMN Viewer';
        }
        
        function markAsSaved() {
            hasUnsavedChanges = false;
            document.getElementById('unsavedDot').classList.remove('visible');
            document.title = 'BPMN Viewer';
        }
        
        // Notifications
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notif = document.createElement('div');
            notif.className = 'notification ' + type;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.remove(), 3000);
        }
        
        // Warn before leaving with unsaved changes
        window.onbeforeunload = (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        };
        
        // ========== INFO PANEL FUNCTIONS ==========
        
        // Toggle info panel visibility
        function toggleInfoPanel() {
            const panel = document.getElementById('infoPanel');
            const btn = document.getElementById('btnInfo');
            
            infoPanelOpen = !infoPanelOpen;
            
            if (infoPanelOpen) {
                panel.classList.remove('collapsed');
                panel.classList.add('open');
                btn.classList.add('active');
            } else {
                panel.classList.add('collapsed');
                panel.classList.remove('open');
                btn.classList.remove('active');
            }
        }
        
        // Get element type badge class
        function getTypeBadgeClass(type) {
            if (type.includes('Task')) return 'type-task';
            if (type.includes('Gateway')) return 'type-gateway';
            if (type.includes('Event')) return 'type-event';
            if (type.includes('SubProcess')) return 'type-subprocess';
            return '';
        }
        
        // Get human-readable type name
        function getTypeName(type) {
            const types = {
                'bpmn:Task': '–ó–∞–¥–∞—á–∞',
                'bpmn:UserTask': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞',
                'bpmn:ManualTask': '–†—É—á–Ω–∞—è –∑–∞–¥–∞—á–∞',
                'bpmn:ServiceTask': '–°–µ—Ä–≤–∏—Å–Ω–∞—è –∑–∞–¥–∞—á–∞',
                'bpmn:ScriptTask': '–°–∫—Ä–∏–ø—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
                'bpmn:BusinessRuleTask': '–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–æ',
                'bpmn:SendTask': '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è',
                'bpmn:ReceiveTask': '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
                'bpmn:SubProcess': '–ü–æ–¥–ø—Ä–æ—Ü–µ—Å—Å',
                'bpmn:ExclusiveGateway': '–ò—Å–∫–ª—é—á–∞—é—â–∏–π —à–ª—é–∑ (XOR)',
                'bpmn:ParallelGateway': '–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π —à–ª—é–∑ (AND)',
                'bpmn:InclusiveGateway': '–í–∫–ª—é—á–∞—é—â–∏–π —à–ª—é–∑ (OR)',
                'bpmn:EventBasedGateway': '–°–æ–±—ã—Ç–∏–π–Ω—ã–π —à–ª—é–∑',
                'bpmn:StartEvent': '–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                'bpmn:EndEvent': '–ö–æ–Ω–µ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                'bpmn:IntermediateCatchEvent': '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (catch)',
                'bpmn:IntermediateThrowEvent': '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (throw)',
                'bpmn:BoundaryEvent': '–ì—Ä–∞–Ω–∏—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                'bpmn:DataObjectReference': '–û–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö',
                'bpmn:DataStoreReference': '–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö',
                'bpmn:TextAnnotation': '–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è',
                'bpmn:Lane': '–î–æ—Ä–æ–∂–∫–∞',
                'bpmn:Participant': '–£—á–∞—Å—Ç–Ω–∏–∫ (Pool)'
            };
            return types[type] || type.replace('bpmn:', '');
        }
        
        // Parse documentation - try JSON first, then plain text
        function parseDocumentation(docText) {
            if (!docText) return null;
            
            // Try to parse as JSON
            try {
                return JSON.parse(docText);
            } catch (e) {
                // Return as plain text
                return { description: docText };
            }
        }
        
        // Show element info in panel
        function showElementInfo(element) {
            const bo = element.businessObject;
            const panel = document.getElementById('infoPanelContent');
            
            // Auto-open panel if closed
            if (!infoPanelOpen) {
                toggleInfoPanel();
            }
            
            // Get basic info
            const name = bo.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
            const id = element.id;
            const type = element.type;
            
            // Get documentation
            const docText = bo.documentation && bo.documentation[0] ? bo.documentation[0].text : null;
            const docData = parseDocumentation(docText);
            
            // Get traceability data (from external JSON if loaded)
            const traceData = traceabilityData && traceabilityData.elements ? traceabilityData.elements[id] : null;
            
            // Merge data (external JSON takes priority)
            const merged = { ...docData, ...traceData };
            
            // Build HTML
            let html = '';
            
            // Element name
            html += '<div class="info-section">';
            html += '<div class="info-section-title">üìå –ù–∞–∑–≤–∞–Ω–∏–µ</div>';
            html += '<div class="info-value" style="font-weight: 600; font-size: 1rem;">' + escapeHtml(name) + '</div>';
            html += '</div>';
            
            // Element type
            html += '<div class="info-section">';
            html += '<div class="info-section-title">üè∑Ô∏è –¢–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞</div>';
            html += '<span class="info-badge ' + getTypeBadgeClass(type) + '">' + getTypeName(type) + '</span>';
            html += '</div>';
            
            // ID
            html += '<div class="info-section">';
            html += '<div class="info-section-title">üîë ID</div>';
            html += '<div class="info-value" style="font-family: monospace; font-size: 0.8rem; color: #718096;">' + escapeHtml(id) + '</div>';
            html += '</div>';
            
            // Source document section (if available)
            if (merged.section || merged.source) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üìÑ –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>';
                
                const source = merged.source || {};
                const doc = source.document || merged.document || '';
                const section = source.section || merged.section || '';
                const page = source.page || merged.page || '';
                
                if (doc) {
                    html += '<div class="info-value"><strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> ' + escapeHtml(doc) + '</div>';
                }
                if (section) {
                    html += '<div class="info-value"><strong>–†–∞–∑–¥–µ–ª:</strong> –ø.' + escapeHtml(section) + '</div>';
                }
                if (page) {
                    html += '<div class="info-value"><strong>–°—Ç—Ä–∞–Ω–∏—Ü–∞:</strong> ' + page + '</div>';
                }
                html += '</div>';
            }
            
            // Quote (if available)
            const quote = merged.quote || (merged.source && merged.source.quote);
            if (quote) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üí¨ –¶–∏—Ç–∞—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>';
                html += '<div class="info-quote">"' + escapeHtml(quote) + '"</div>';
                html += '</div>';
            }
            
            // Description (plain documentation)
            if (merged.description && merged.description !== quote) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üìù –û–ø–∏—Å–∞–Ω–∏–µ</div>';
                html += '<div class="info-value">' + escapeHtml(merged.description) + '</div>';
                html += '</div>';
            }
            
            // Responsible (if available)
            if (merged.responsible) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div>';
                html += '<div class="info-value">' + escapeHtml(merged.responsible) + '</div>';
                html += '</div>';
            }
            
            // Duration (if available)
            if (merged.duration) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>';
                html += '<div class="info-value">' + escapeHtml(merged.duration) + '</div>';
                html += '</div>';
            }
            
            // System (if available)
            if (merged.system) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üíª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>';
                html += '<span class="info-badge">' + escapeHtml(merged.system) + '</span>';
                html += '</div>';
            }
            
            // Output documents (if available)
            if (merged.outputDocs && merged.outputDocs.length > 0) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üìã –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –≤—ã—Ö–æ–¥–µ</div>';
                html += '<div class="info-value">';
                merged.outputDocs.forEach(doc => {
                    html += '<span class="info-badge" style="margin: 2px;">' + escapeHtml(doc) + '</span>';
                });
                html += '</div>';
                html += '</div>';
            }
            
            // Links (if OCR anchor available)
            const ocrAnchor = merged.ocrAnchor || (merged.source && merged.source.ocrAnchor);
            if (ocrAnchor || merged.section) {
                html += '<div class="info-section">';
                html += '<div class="info-section-title">üîó –°—Å—ã–ª–∫–∏</div>';
                if (ocrAnchor) {
                    html += '<a class="info-link" onclick="copyToClipboard(\'' + ocrAnchor + '\')">üìé –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —è–∫–æ—Ä—å</a>';
                }
                html += '</div>';
            }
            
            // SubProcess drill-down hint
            if (type === 'bpmn:SubProcess') {
                html += '<div class="info-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0;">';
                html += '<div class="info-value" style="color: #667eea; text-align: center;">';
                html += 'üí° –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤–Ω—É—Ç—Ä—å –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–∞';
                html += '</div>';
                html += '</div>';
            }
            
            panel.innerHTML = html;
        }
        
        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text, 'success');
            }).catch(() => {
                showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
            });
        }
        
        // Load traceability from JSON content (used by drag-drop and file picker)
        function loadTraceabilityContent(content, name) {
            try {
                traceabilityData = JSON.parse(content);
                document.getElementById('traceLoaded').classList.remove('hidden');
                const count = Object.keys(traceabilityData.elements || {}).length;
                showNotification('‚úÖ –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞: ' + name + ' (' + count + ' —ç–ª–µ–º–µ–Ω—Ç–æ–≤)', 'success');
                return true;
            } catch (err) {
                console.error('Traceability parse error:', err);
                showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' + err.message, 'error');
                return false;
            }
        }
        
        // Extract embedded traceability from BPMN XML
        function extractEmbeddedTraceability(xmlContent) {
            // Method 1: Look for <!-- TRACEABILITY_JSON: {...} --> comment
            const commentMatch = xmlContent.match(/<!--\s*TRACEABILITY_JSON:\s*(\{[\s\S]*?\})\s*-->/);
            if (commentMatch) {
                try {
                    return JSON.parse(commentMatch[1]);
                } catch (e) {
                    console.warn('Failed to parse embedded traceability comment:', e);
                }
            }
            
            // Method 2: Look for custom namespace in extensionElements (advanced)
            // This would require XML parsing, keeping it simple for now
            
            return null;
        }
        
        // Load external traceability JSON file (button click)
        async function loadTraceabilityFile() {
            try {
                const options = {
                    types: [{
                        description: 'Traceability JSON',
                        accept: { 'application/json': ['.json'] }
                    }]
                };
                
                const [handle] = await window.showOpenFilePicker(options);
                const file = await handle.getFile();
                const content = await file.text();
                
                loadTraceabilityContent(content, handle.name);
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                }
            }
        }
    </script>
</body>
</html>