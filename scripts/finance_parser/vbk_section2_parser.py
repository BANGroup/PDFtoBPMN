#!/usr/bin/env python3
"""
–ü–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –†–∞–∑–¥–µ–ª–∞ II –¥–æ–∫—É–º–µ–Ω—Ç–∞ VBK.
–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Excel —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏.
"""

import fitz
import pandas as pd
import re
from pathlib import Path
from openpyxl import load_workbook
from openpyxl.styles import numbers


class VBKSection2Parser:
    """–ü–∞—Ä—Å–µ—Ä –¥–ª—è –†–∞–∑–¥–µ–ª–∞ II (–°–≤–µ–¥–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö)"""
    
    def __init__(self, pdf_path: str):
        self.pdf_path = pdf_path
        self.doc = None
        self.all_data = []
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–∏–Ω–¥–µ–∫—Å—ã –≤ DataFrame)
        self.financial_columns = [
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–ª–∞—Ç–µ–∂) - —Å—É–º–º–∞",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç) - —Å—É–º–º–∞"
        ]
        
    def parse(self):
        """–ò–∑–≤–ª–µ—á—å —Ç–∞–±–ª–∏—Ü—É –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –†–∞–∑–¥–µ–ª–∞ II"""
        self.doc = fitz.open(self.pdf_path)
        
        print(f"üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: {self.pdf_path}")
        print(f"üìä –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {len(self.doc)}")
        print()
        
        # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–∞—á–∞–ª–æ–º –†–∞–∑–¥–µ–ª–∞ II
        start_page = self._find_section2_start()
        if start_page is None:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω '–†–∞–∑–¥–µ–ª II' –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ")
            return []
        
        print(f"‚úÖ –†–∞–∑–¥–µ–ª II –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ {start_page + 1}")
        print()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, –ø–æ–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –†–∞–∑–¥–µ–ª—É II
        # (19-20 –∫–æ–ª–æ–Ω–æ–∫). –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è, –∫–æ–≥–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—è–µ—Ç—Å—è (15 –∫–æ–ª–æ–Ω–æ–∫ = –†–∞–∑–¥–µ–ª III)
        page_num = start_page
        while page_num < len(self.doc):
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ç–∞–±–ª–∏—Ü—É
            should_continue = self._extract_table_from_page(page_num)
            
            if not should_continue:
                print(f"  ‚ö†Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –∏–∑–º–µ–Ω–∏–ª–∞—Å—å - –∫–æ–Ω–µ—Ü –†–∞–∑–¥–µ–ª–∞ II")
                break
            
            page_num += 1
        
        print(f"\nüìç –†–∞–∑–¥–µ–ª II: —Å—Ç—Ä–∞–Ω–∏—Ü—ã {start_page + 1} - {page_num}")
        
        self.doc.close()
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–∏–Ω DataFrame
        if not self.all_data:
            print("‚ùå –ù–µ –∏–∑–≤–ª–µ—á–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö")
            return pd.DataFrame()
        
        df = pd.concat(self.all_data, ignore_index=True)
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        df = self._clean_data(df)
        
        print(f"\nüìä –ò–∑–≤–ª–µ—á–µ–Ω–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        print(f"üìä –ö–æ–ª–æ–Ω–æ–∫: {len(df.columns)}")
        
        return df
    
    def _find_section2_start(self) -> int:
        """–ù–∞–π—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–∞—á–∞–ª–æ–º –†–∞–∑–¥–µ–ª–∞ II"""
        for page_num in range(len(self.doc)):
            page = self.doc[page_num]
            text = page.get_text()
            if '–†–∞–∑–¥–µ–ª II' in text:
                return page_num
        return None
    
    def _extract_table_from_page(self, page_num: int) -> bool:
        """
        –ò–∑–≤–ª–µ—á—å —Ç–∞–±–ª–∏—Ü—É —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            True - –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –†–∞–∑–¥–µ–ª–∞ II (19-20 –∫–æ–ª–æ–Ω–æ–∫), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            False - –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (15 –∫–æ–ª–æ–Ω–æ–∫ = –†–∞–∑–¥–µ–ª III), –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
        """
        page = self.doc[page_num]
        
        tab_finder = page.find_tables()
        tables = tab_finder.tables
        
        if not tables:
            print(f"  –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page_num + 1}: —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return True  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–∫–∞—Ç—å
        
        # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        # (–Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü)
        table = tables[0]
        df = table.to_pandas()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
        num_cols = len(df.columns)
        
        # –†–∞–∑–¥–µ–ª II: 19-20 –∫–æ–ª–æ–Ω–æ–∫
        # –†–∞–∑–¥–µ–ª III: 15 –∫–æ–ª–æ–Ω–æ–∫
        if num_cols < 18:
            # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å - —ç—Ç–æ —É–∂–µ –Ω–µ –†–∞–∑–¥–µ–ª II
            return False
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
        # (–Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö —Ä–∞–∑–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
        df.columns = range(len(df.columns))
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏:
        # - –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
        # - –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è None –∏–ª–∏ –ø—É—Å—Ç—ã–µ
        # - –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∫–æ–ª–æ–Ω–æ–∫ (1, 2, 3, ...)
        # - –ò–°–ü–†–ê–í–õ–Ø–ï–ú –°–ú–ï–©–ï–ù–ò–ï –ö–û–õ–û–ù–û–ö –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
        
        cleaned_rows = []
        for idx, row in df.iterrows():
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (‚Ññ –ø/–ø) —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∏—Å–ª–æ
            first_col = str(row.iloc[0]).strip()
            
            if not first_col or first_col in ['None', '', 'nan']:
                continue
            
            # –®–ê–ì 1: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ú–ï–©–ï–ù–ò–Ø (–¥–µ–ª–∞–µ–º –ü–ï–†–í–´–ú!)
            # –ï—Å–ª–∏ Col 1 = None/nan, –∞ Col 2 –ø–æ—Ö–æ–∂–µ –Ω–∞ –¥–∞—Ç—É - —É–¥–∞–ª—è–µ–º Col 1
            if len(row) > 2:
                col1_val = str(row.iloc[1]).strip()
                col2_val = str(row.iloc[2]).strip()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω –¥–∞—Ç—ã DD.MM.YYYY
                is_col2_date = bool(re.match(r'\d{2}\.\d{2}\.\d{4}', col2_val))
                
                if col1_val in ['None', 'nan', ''] and is_col2_date:
                    # –°–º–µ—â–µ–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ - —É–¥–∞–ª—è–µ–º Col 1 (—Å–¥–≤–∏–≥–∞–µ–º –≤—Å–µ –≤–ª–µ–≤–æ)
                    row = pd.concat([row.iloc[:1], row.iloc[2:]], ignore_index=True)
            
            # –®–ê–ì 2: –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ó–ê–ì–û–õ–û–í–ö–û–í (–¥–µ–ª–∞–µ–º –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ—â–µ–Ω–∏—è!)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å—Ç—Ä–æ–∫–∞ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∫–æ–ª–æ–Ω–æ–∫ (1, 2, 3, ...)
            # –£–¢–û–ß–ù–ï–ù–ò–ï: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ –≤—Ç–æ—Ä—É—é –∫–æ–ª–æ–Ω–∫—É - –µ—Å–ª–∏ —Ç–∞–º –¥–∞—Ç–∞, —Ç–æ —ç—Ç–æ –ù–ï –∑–∞–≥–æ–ª–æ–≤–æ–∫
            if first_col in ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 
                              '11', '12', '13', '14', '15', '16', '17', '18', '19'] and idx < 5:
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤–æ –≤—Ç–æ—Ä–æ–π –∫–æ–ª–æ–Ω–∫–µ –¥–∞—Ç–∞ - —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                second_col = str(row.iloc[1] if len(row) > 1 else '').strip()
                if not re.match(r'\d{2}\.\d{2}\.\d{4}', second_col):
                    # –ù–µ—Ç –¥–∞—Ç—ã –≤–æ –≤—Ç–æ—Ä–æ–π –∫–æ–ª–æ–Ω–∫–µ - —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    continue
            
            # –û–±—Ä–µ–∑–∞–µ–º –¥–æ 19 –∫–æ–ª–æ–Ω–æ–∫ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã)
            if len(row) > 19:
                row = row[:19]
            
            cleaned_rows.append(row)
        
        if cleaned_rows:
            page_df = pd.DataFrame(cleaned_rows)
            # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —É –Ω–∞—Å —Ä–æ–≤–Ω–æ 19 –∫–æ–ª–æ–Ω–æ–∫
            if len(page_df.columns) < 19:
                for i in range(len(page_df.columns), 19):
                    page_df[i] = None
            elif len(page_df.columns) > 19:
                page_df = page_df.iloc[:, :19]
            
            self.all_data.append(page_df)
            print(f"  –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page_num + 1}: –∏–∑–≤–ª–µ—á–µ–Ω–æ {len(cleaned_rows)} —Å—Ç—Ä–æ–∫")
        
        return True  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–∑–≤–ª–µ–∫–∞—Ç—å
    
    def _clean_data(self, df: pd.DataFrame) -> pd.DataFrame:
        """–û—á–∏—Å—Ç–∏—Ç—å –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ"""
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
        headers = [
            "‚Ññ –ø/–ø",
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏",
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ø—Ä–∏–∑–Ω–∞–∫) –ø–ª–∞—Ç–µ–∂–∞",
            "–ü—Ä–∏–∑–Ω–∞–∫ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–æ–º",
            "–ö–æ–¥ –≤–∏–¥–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏",
            "–ö–æ–¥ –≤–∞–ª—é—Ç—ã –∫–æ—Ä—Ä.—Å—á–µ—Ç–∞",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–ª–∞—Ç–µ–∂) - –∫–æ–¥ –≤–∞–ª—é—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–ª–∞—Ç–µ–∂) - —Å—É–º–º–∞",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç) - –∫–æ–¥ –≤–∞–ª—é—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç) - —Å—É–º–º–∞",
            "–û–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫ —Ä–µ–ø–∞—Ç—Ä–∏–∞—Ü–∏–∏",
            "–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã –±–∞–Ω–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è/–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è",
            "–ë–∞–Ω–∫-–Ω–µ—Ä–µ–∑–∏–¥–µ–Ω—Ç - –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã",
            "–ë–∞–Ω–∫-–Ω–µ—Ä–µ–∑–∏–¥–µ–Ω—Ç - –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
            "–ë–∞–Ω–∫-–Ω–µ—Ä–µ–∑–∏–¥–µ–Ω—Ç - –∫–æ–¥ –±–∞–Ω–∫–∞",
            "–ë–∞–Ω–∫-–Ω–µ—Ä–µ–∑–∏–¥–µ–Ω—Ç - –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞",
            "–ü—Ä–∏–∑–Ω–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏",
            "–ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤",
            "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"
        ]
        
        # DataFrame —É–∂–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å 19 –∫–æ–ª–æ–Ω–æ–∫ (—á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã 0-18)
        # –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∏—Ö
        if len(df.columns) == 19:
            df.columns = headers
        else:
            # –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
            print(f"‚ö†Ô∏è WARNING: –û–∂–∏–¥–∞–ª–æ—Å—å 19 –∫–æ–ª–æ–Ω–æ–∫, –ø–æ–ª—É—á–µ–Ω–æ {len(df.columns)}")
            # –û–±—Ä–µ–∑–∞–µ–º –∏–ª–∏ –¥–æ–ø–æ–ª–Ω—è–µ–º
            if len(df.columns) < 19:
                for i in range(len(df.columns), 19):
                    df[i] = None
            elif len(df.columns) > 19:
                df = df.iloc[:, :19]
            df.columns = headers
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ float
        for col in self.financial_columns:
            if col in df.columns:
                df[col] = df[col].apply(self._parse_number)
        
        # –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        df = df.replace(['None', 'nan', ''], None)
        
        return df
    
    def _parse_number(self, value):
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ"""
        if pd.isna(value) or value is None or value == '':
            return None
        
        value_str = str(value).strip()
        if not value_str or value_str in ['None', 'nan', '']:
            return None
        
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –∑–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
        value_str = value_str.replace(' ', '').replace(',', '')
        
        try:
            return float(value_str)
        except ValueError:
            return None
    
    def save_to_excel(self, df: pd.DataFrame, output_path: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Excel —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏"""
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel
        df.to_excel(output_path, index=False, engine='openpyxl')
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        wb = load_workbook(output_path)
        ws = wb.active
        
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        header_row = list(df.columns)
        financial_col_indices = []
        
        for col_name in self.financial_columns:
            if col_name in header_row:
                col_idx = header_row.index(col_name) + 1  # +1 —Ç.–∫. Excel 1-indexed
                financial_col_indices.append(col_idx)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å 2 –∑–Ω–∞–∫–∞–º–∏
        for col_idx in financial_col_indices:
            for row in range(2, ws.max_row + 1):  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                cell = ws.cell(row=row, column=col_idx)
                if cell.value is not None:
                    cell.number_format = numbers.FORMAT_NUMBER_00  # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å 2 –∑–Ω–∞–∫–∞–º–∏
        
        wb.save(output_path)
        print(f"\nüíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: {output_path}")
        print(f"   –ü—Ä–∏–º–µ–Ω–µ–Ω —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è {len(financial_col_indices)} –∫–æ–ª–æ–Ω–æ–∫")


if __name__ == '__main__':
    pdf_path = "input/VBK16040002_1971_0019_9_1_2216_0008_20251111_–±–æ–ª—å—à–∞—è.pdf"
    output_path = "output/finance/VBK_–†–∞–∑–¥–µ–ª_II.xlsx"
    
    # –°–æ–∑–¥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—É—é –ø–∞–ø–∫—É
    Path(output_path).parent.mkdir(parents=True, exist_ok=True)
    
    # –ü–∞—Ä—Å–∏–º
    parser = VBKSection2Parser(pdf_path)
    df = parser.parse()
    
    if not df.empty:
        parser.save_to_excel(df, output_path)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print("\n" + "="*80)
        print("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        print(f"   –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: {len(df)}")
        print(f"   –í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫: {len(df.columns)}")
        print(f"   –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {parser.financial_columns}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫
        print("\nüìã –ü–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏:")
        print(df.head(3).to_string())

