---
description: File structure, naming conventions, access rules
globs:
  - "**/*"
alwaysApply: true
---

# Файловая структура проекта

## Организация папок

**ВАЖНО:** Все имена документов и папок ниже — **ПРИМЕРЫ**. Реальные названия определяются автоматически из имени входного файла.

```
/home/budnik_an/Obligations/
|
+-- input/                           # Входные документы (READ-ONLY для AI)
|   +-- [ИмяДокумента].pdf
|
+-- output/                          # Результаты обработки (WORKSPACE для AI)
|   +-- [БазовоеИмя]/
|       +-- [БазовоеИмя]_OCR.md
|       +-- [БазовоеИмя]_OCR.pdf
|       +-- [БазовоеИмя]_RACI.md
|       +-- [БазовоеИмя]_RACI.pdf
|       +-- [БазовоеИмя]_Pipeline.md
|       +-- [БазовоеИмя]_Pipeline.pdf
|       +-- [БазовоеИмя].bpmn
|       +-- [БазовоеИмя].md
|       +-- [БазовоеИмя].pdf
|
+-- scripts/                         # Рабочий код проекта
|   +-- pdf_to_context/              # Основной модуль обработки PDF
|   |   +-- pipeline.py              # Главный пайплайн
|   |   +-- core/                    # Ядро системы
|   |   +-- extractors/              # Извлечение данных
|   |   +-- ir/                      # Промежуточное представление
|   |   +-- models/                  # Модели данных
|   |   +-- ocr_service/             # OCR интеграция
|   +-- document_graph/              # Граф документов СМК
|   +-- graph/                       # Граф знаний (RACI/Pipeline/BPMN)
|   +-- rag/                         # RAG-система
|   +-- utils/                       # Утилиты для пользователей
|   |   +-- run_document.py          # Универсальный обработчик (PDF/DOCX/XLSX)
|   |   +-- generate_docx.py         # Генерация DOCX копий
|   |   +-- check_bpmn.sh            # Проверка BPMN
|   +-- tests/                       # Тесты
|   +-- tools/                       # Инструменты (BPMN Viewer, графы)
|
+-- archive/                         # Архив старых версий
+-- DeepSeek-OCR/                    # Модуль DeepSeek OCR
+-- docs/                            # Документация проекта
+-- docker/                          # Docker-инфраструктура
+-- input2/                          # Локальные входные документы (НЕ в git)
+-- output2/                         # Локальные результаты (НЕ в git)
+-- .cursor/rules/                   # Модульные правила AI
+-- .cursor/agents/                  # Профили агентов
+-- README.md
+-- Changelog.md
+-- requirements.txt
```

## Правила доступа к папкам

### input/ (READ-ONLY для AI)
- **Назначение**: Хранение исходных PDF документов
- **Доступ AI**: Только чтение
- **ЗАПРЕЩЕНО**: Создание, изменение, удаление файлов
- **Управление**: Только пользователь вручную добавляет документы

### output/ (WORKSPACE для AI)
- **Назначение**: Результаты автоматической обработки
- **Структура**: Папка создается автоматически при обработке
- **Название папки**: Имя документа без расширения и спецсимволов
- **Стандартный набор**: 9 файлов на документ (MD + PDF/DOCX + BPMN)

### input2/ (ЛОКАЛЬНАЯ, READ-ONLY для AI)
- **Назначение**: Конфиденциальные входные документы (НЕ попадает в git)
- **Доступ AI**: Только чтение
- **Git**: Исключена из git (.gitignore)
- **Симлинки**: НЕ использовать (только реальные файлы)

### output2/ (ЛОКАЛЬНАЯ, WORKSPACE для AI)
- **Назначение**: Результаты обработки документов из input2/
- **Доступ AI**: Чтение и запись
- **Git**: Исключена из git (.gitignore)
- **Структура**: Аналогична output/

### ПРАВИЛО МАРШРУТИЗАЦИИ:

| Входная папка | Выходная папка |
|---------------|----------------|
| `input/` | `output/` |
| `input2/` | `output2/` |

```bash
# Обработка из input2:
python3 scripts/utils/run_document.py input2/document.pdf --output-dir output2
```

### scripts/ (Рабочий код)
- **Назначение**: Весь функциональный код проекта
- **Доступ AI**: Чтение и запись при разработке

### archive/ (Архив)
- **Назначение**: Хранение старых версий, тестов, экспериментов
- **Доступ AI**: Только чтение, при необходимости

## Правила именования файлов

### Алгоритм очистки имени документа:

```python
# Из имени файла получаем базовое имя:
# 1. Взять имя файла без расширения
# 2. Убрать содержимое в скобках: "(Эталон N14)" -> ""
# 3. Убрать спецсимволы кроме дефиса и подчеркивания
# 4. Заменить пробелы на подчеркивания
# 5. Удалить повторяющиеся подчеркивания
# 6. Удалить подчеркивания в начале/конце

# Примеры:
# "ДП-М1.020-06 (Эталон N14 для ознакомления).pdf" -> "ДП-М1.020-06"
# "КД-СТ-161-01 (Эталон для ознакомления).pdf" -> "КД-СТ-161-01"
# "Руководство по качеству.pdf" -> "Руководство_по_качеству"
```

### Связанные файлы процесса

**Для каждого процесса создается 9 файлов со связанными именами:**

```
Базовое имя: ДП-М1.020-06

output/ДП-М1.020-06/
+-- ДП-М1.020-06_OCR.md           # Расшифровка (MD)
+-- ДП-М1.020-06_OCR.pdf          # Расшифровка (PDF)
+-- ДП-М1.020-06_RACI.md          # RACI матрица (MD)
+-- ДП-М1.020-06_RACI.pdf         # RACI матрица (PDF)
+-- ДП-М1.020-06_Pipeline.md      # Пайплайн (MD)
+-- ДП-М1.020-06_Pipeline.pdf     # Пайплайн (PDF)
+-- ДП-М1.020-06.bpmn             # BPMN (только XML)
+-- ДП-М1.020-06.md               # Документация (MD)
+-- ДП-М1.020-06.pdf              # Документация (PDF)
```

**ПРАВИЛО СВЯЗИ:**
- Базовое название одинаковое для всех файлов
- Различаются только суффиксы: `_OCR`, `_RACI`, `_Pipeline`, `.bpmn`, `.md`

### Версионирование
- При создании новой версии: `_v2`, `_v3` и т.д.
- Пример: `ДП-М1.020-06_v2_RACI.md`
- Старые версии перемещать в `archive/old_output/`

### Архивирование
- Старые версии -> `archive/old_output/`
- Не удалять исходные документы из `input/`

## Утилиты (scripts/utils/)

### run_document.py — Универсальный обработчик (PDF/DOCX/XLSX)

```bash
python3 scripts/utils/run_document.py <путь_к_файлу> [опции]
```

**Поддерживаемые форматы:**

| Формат | Что извлекается |
|--------|-----------------|
| PDF | Native text + таблицы + структура. OCR опционально (--enable-ocr) |
| DOCX | Параграфы + таблицы + стили + изображения |
| XLSX | Листы + ячейки + формулы + результаты |

**Опции:** `--enable-ocr`, `--output <path>`, `--no-images`, `--no-tables`, `--verbose`

### generate_docx.py — Генерация DOCX копий

```bash
python3 scripts/utils/generate_docx.py <output_dir> <base_name>
```

Создает DOCX версии всех MD файлов (требуется pandoc).

### test_deepseek_ocr.py — Тест OCR

```bash
python3 scripts/utils/test_deepseek_ocr.py
```

Проверяет PyTorch + CUDA, загрузку модели, inference.
