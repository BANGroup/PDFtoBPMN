---
description: BPMN modeling methodology (analysis, RACI, Pipeline, BPMN creation, validation, large documents)
globs:
  - "output/**/*.bpmn"
  - "output/**/*_RACI.md"
  - "output/**/*_Pipeline.md"
  - "output/**/*.md"
  - "output2/**"
alwaysApply: false
---

# Методология моделирования процессов

## Этап 1: Анализ и структурирование

### 1.1 Анализ исходных документов

1. **Идентификация типа процесса:** операционный / управленческий / поддерживающий
2. **Определение границ:** триггер, входы, выходы, окончание
3. **Выявление ключевых разделов:** по фазам, функциональным областям, временным периодам
4. **Оценка объёма:** количество участников, шагов, точек принятия решений

### 1.2 Автоматическое структурирование

**Оценка размера документа:**

| Размер | Разделов | Подход |
|--------|----------|--------|
| < 50 стр. | < 5 | Одна детальная диаграмма (без SubProcess) |
| 50-150 стр. | 5-10 | Главная + SubProcess для крупных разделов |
| > 150 стр. | > 10 | Главная + SubProcess для всех разделов |

**5 критериев для SubProcess (для каждого раздела):**
1. Отдельная тема? (+1 балл)
2. Своя ролевая модель (2+ уникальных роли)? (+1 балл)
3. Относительная автономность? (+1 балл)
4. >= 3 задач? (+1 балл)
5. Есть вариативность (условия, Gateway)? (+1 балл)

**Решение:** 3-5 баллов -> SubProcess, 0-2 балла -> задачи в главной диаграмме.

**ВСЕГДА использовать SubProcess** (не Call Activity) для структурирования в один файл.

**Оптимальная структура:** 1-5 lanes верхнего уровня (макс 7), 5-10 SubProcess.

### 1.3 Валидация: AS-IS моделирование

**ВСЕ схемы по умолчанию создаются AS-IS!**

**КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО:**
- Добавлять связи, которых НЕТ в документе
- "Додумывать" логику по здравому смыслу
- Создавать элементы без ссылки на пункт документа
- Упрощать или оптимизировать (это TO-BE)

**ОБЯЗАТЕЛЬНО:**
- Каждый элемент = конкретный пункт документа
- Если связь неочевидна -> СПРОСИТЬ, не додумывать
- Если противоречие -> ЗАФИКСИРОВАТЬ и уточнить

### 1.4 Проверка соответствия Pipeline и BPMN

- "параллельно", "одновременно" -> Parallel Gateway
- "затем", "после", "далее" -> Sequence Flow
- "если X, то Y, иначе Z" -> Exclusive Gateway
- "цикл доработки", "возврат" -> обратный Sequence Flow
- Закрытый список ролей -> Parallel Gateway + отдельные задачи
- Открытый список ("заинтересованные подразделения") -> Multi-Instance Task

---

## Этап 2: Матрица ответственности RACI

### 2.1 Формат файла: `output/[Процесс]/[Процесс]_RACI.md`

**Для КАЖДОГО раздела — матрица:**

| Пункт | Activity / Задача | Роль 1 | Роль 2 | Роль 3 |
|-------|-------------------|--------|--------|--------|
| п.7.2 | Задача 1 | R | A | C |

**Первый столбец `Пункт` — ОБЯЗАТЕЛЬНАЯ ссылка на раздел документа!**

**Обозначения:**
- **R** (Responsible) — исполнитель
- **A** (Accountable) — ответственный за результат
- **C** (Consulted) — консультант
- **I** (Informed) — информируемый

### 2.2 Ролевая модель

**ОБЯЗАТЕЛЬНО согласовать с пользователем:**

```
РОЛЕВАЯ МОДЕЛЬ ПРОЦЕССА

Выявленные роли:
1. [Роль 1] - [Описание]
2. [Роль 2] - [Описание]

СТРУКТУРА POOL И LANES:
POOL: [Название процесса]
+-- LANE 1: [Роль]
+-- LANE 2: [Роль]
+-- LANE 3: [Роль]

Согласны с такой структурой?
```

**Правила lanes:**
- Каждая lane = одна роль или подразделение
- Lane содержит только задачи с R или A для этой роли
- Оптимально 3-8 lanes

---

## Этап 3: Текстовый пайплайн процесса

### Формат файла: `output/[Процесс]/[Процесс]_Pipeline.md`

### 3.1 Структура описания каждого Activity

**Для КАЖДОГО элемента процесса — 7 пунктов:**

```
ACTIVITY: [Номер] - [Название]

ТРАССИРОВКА К ИСТОЧНИКУ:
  Документ: [Название]
  Пункт: [Номер пункта]
  Цитата: "[Ключевая фраза]"

1. НАЗВАНИЕ И ТИП:
   Тип: Manual Task / Service Task / User Task
   Способ: АВТОМАТИЗИРОВАН / РУЧНАЯ ОПЕРАЦИЯ / ЧЕРЕЗ ИС
   Степень автоматизации: [0-100%]

2. ОТВЕТСТВЕННЫЙ:
   RACI роль: R / A
   Должность: [...]
   Lane: [...]

3. ВХОДЫ И ВЫХОДЫ:
   Входящие данные: [...]
   Исходящие данные: [...]
   Способы передачи: [ИС, Email, Физически]

4. ВРЕМЕННЫЕ ХАРАКТЕРИСТИКИ:
   Плановое время: [X рабочих дней]
   Зависимости: [предшествующие/последующие задачи]

5. МЕТРИКИ И KPI:
   Соблюдение срока, качество результата
   Триггеры эскалации: [условие -> действие]

6. УСЛОВИЯ И ПРАВИЛА:
   Бизнес-правила: [...]
   Критерии качества: [...]

7. РИСКИ И ИСКЛЮЧЕНИЯ:
   Типичные проблемы: [проблема -> решение]
```

### 3.2 Сводный пайплайн

```
ПОЛНЫЙ ПАЙПЛАЙН: [Название]

START -> [Activity 1] -> [Gateway?] -> [Activity 2] -> ... -> END

ОБЩИЕ МЕТРИКИ:
- Lead Time: [X дней]
- Process Time: [Y дней]
- Эффективность: [Z%]
```

---

## Этап 4: Создание BPMN и документации

### Два связанных файла:

1. **BPMN XML:** `output/[Процесс]/[Процесс].bpmn`
2. **MD документация:** `output/[Процесс]/[Процесс].md` (ТО ЖЕ ИМЯ!)

### 4.1 Трассировка к исходному документу (ОБЯЗАТЕЛЬНО!)

**Каждый элемент BPMN ОБЯЗАН содержать `<bpmn:documentation>`:**

```xml
<bpmn:userTask id="Task_7_2" name="Принятие решения">
  <bpmn:documentation>Документ: РД-Б7.004-05, п.7.2

Руководитель ПФМ принимает решение о заключении договора.

Ответственный: Руководитель ПФМ
Срок: 2 рабочих дня</bpmn:documentation>
</bpmn:userTask>
```

**Ограничения:** 1-3 предложения, детали в MD.

### 4.2 Структура MD документации

```markdown
# Название процесса

## Таблица 1. События процесса
| Пункт | Название | Тип | Описание |
|-------|----------|-----|----------|

## Таблица 2. Шлюзы
| Пункт | Название | Тип | Условие |
|-------|----------|-----|---------|

## Таблица 3. Задачи в дорожке "Роль"
| Пункт | Название | Ответственный | Срок | Описание |
|-------|----------|---------------|------|----------|
```

**Названия в MD ТОЧНО соответствуют атрибуту `name` в BPMN XML!**

### 4.3 Валидация и рефлексия BPMN

**ОБЯЗАТЕЛЬНО после создания BPMN:**

#### Шаг 1: Сверка с RACI
- Количество lanes == количество ролей в RACI
- Названия lanes точно соответствуют RACI
- Задачи с R в правильных lanes

#### Шаг 2: Сверка с Pipeline
- Количество tasks = количество activities в Pipeline (+-10%)
- Параллельность -> Parallel Gateway
- Условия -> Exclusive Gateway
- Циклы -> обратные flows

#### Шаг 3: Проверка SubProcess
- Каждый SubProcess имеет минимум 1 lane
- Lanes визуализированы в BPMNDiagram
- Drill-down работает

#### Шаг 4: Логическая корректность
- Причинно-следственные связи корректны
- Вариативность отражена Gateway
- Входы/выходы корректны

#### Шаг 5: Технические проверки
- Нет дублирующих sequenceFlow
- Нет неразрешенных ссылок
- Все BPMNShape/BPMNEdge на месте

#### Шаг 6: Количественные метрики
```bash
echo "Lanes:" && grep -c '<bpmn:lane id=' file.bpmn
echo "Tasks:" && grep -c 'Task' file.bpmn
echo "Gateways:" && grep -c 'Gateway' file.bpmn
echo "SubProcess:" && grep -c '<bpmn:subProcess' file.bpmn
```

#### Шаг 7: Финальная валидация
- Если хотя бы одна проверка FAIL -> исправить ПЕРЕД продолжением

#### Шаг 8: Обязательный отчет валидации (в чат)

---

## Обработка больших документов (>50 страниц)

### Определение "большого документа"

Соответствует ХОТЯ БЫ ОДНОМУ критерию:
- Более 50 страниц
- Более 15 разделов верхнего уровня
- Более 3 уровней вложенности
- Более 100 подпунктов

### ЭТАП -1: Обязательный предварительный анализ

1. **Анализ уровней вложенности** (подсчет Level 1-4)
2. **Создание карты детализации** (таблица SubProcess/Task для каждого X.Y)
3. **Согласование архитектуры с пользователем**

**Интерпретация:**

| Уровни | Архитектура | Сложность | Время |
|--------|-------------|-----------|-------|
| 1-2 | 2-уровневая | Простая | 3-5 часов |
| 3 (X.Y.Z) | 3-уровневая | Средняя | 6-10 часов |
| 4 (X.Y.Z.W) | 4-уровневая | Высокая | 13-18 часов |

### Правила для больших документов

**Критерий SubProcess vs Task:**
- >= 2 подпункта X.Y.Z -> создавать SubProcess
- 0-1 подпункт -> оставлять Task

**Валидация RACI vs OCR:**
- Перед Level 4 проверить количество подпунктов в OCR vs RACI
- При расхождении -> ОСТАНОВИТЬСЯ и скорректировать

**Этапы (для 90+ страниц):**

| Этап | Время | Описание |
|------|-------|----------|
| -1 | 0.5-1 час | Анализ и планирование |
| 1 | 2-3 часа | OCR + RACI + Pipeline |
| 2 | 2-3 часа | BPMN Level 1-2 |
| 3 | 2-3 часа | BPMN Level 3 |
| 4 | 5-6 часов | BPMN Level 4 (структура) |
| 5 | 4-5 часов | BPMN Level 4 (визуализация) |
| 6 | 1-2 часа | Валидация |
| 7 | 0.5-1 час | Документация + DOCX |

**ИТОГО: 16-20 часов активной работы**

### Работа пакетами
- Обрабатывать SubProcess пакетами по 5-7 штук
- Валидация в Camunda после каждого пакета
- При warnings -> ОСТАНОВИТЬСЯ и исправить
