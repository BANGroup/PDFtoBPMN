---
description: Document processing workflow (steps 1-7)
globs:
  - "output/**"
  - "output2/**"
  - "input/**"
  - "input2/**"
  - "scripts/utils/**"
alwaysApply: false
---

# Workflow обработки документа

## Команда пользователя
```
"обработай документ [название]"
```

## Последовательность действий AI (7 шагов)

### ШАГ 1: Проверка и подготовка

#### 1.1 Проверка виртуального окружения
- Убедиться, что venv активировано (`which python3` -> путь в venv/)
- Если НЕ активировано -> ОСТАНОВИТЬСЯ и попросить пользователя

#### 1.2 Проверка файлов и подготовка папок
1. Проверить наличие файла в input/[название]
2. Извлечь базовое имя документа (без расширения)
3. Очистить имя: убрать скобки, спецсимволы, заменить пробелы на `_`
4. Создать папку output/[базовое_имя]/ если не существует

### ШАГ 2: Извлечение контента документа

```bash
python3 scripts/utils/run_document.py input/<файл>
```

**Скрипт автоматически:**
- Определяет формат по расширению (PDF/DOCX/XLSX)
- Создает output папку
- Сохраняет результат: `output/<base_name>/<base_name>_OCR.md`
- Выводит статистику

**Для PDF — два канала:**
1. **Текстовый (Native Extractor)** — ВСЕГДА работает (без GPU)
2. **Графический (OCR)** — ОПЦИОНАЛЬНО с `--enable-ocr` (требует GPU)

**Дополнительные флаги:**
- `--enable-ocr` — включить OCR для PDF (требует GPU)
- `--no-images` — не извлекать изображения
- `--no-tables` — не извлекать таблицы
- `--verbose` — подробный вывод

### ШАГ 3: Создание RACI матрицы
1. Прочитать `[базовое_имя]_OCR.md`
2. Следовать методологии из `30_bpmn_methodology.mdc` (Этап 2: RACI)
3. Создать файл `[базовое_имя]_RACI.md`
4. Согласовать с пользователем структуру ролей

### ШАГ 4: Создание текстового пайплайна
1. На основе OCR и RACI
2. Следовать методологии из `30_bpmn_methodology.mdc` (Этап 3: Pipeline)
3. Создать файл `[базовое_имя]_Pipeline.md`

### ШАГ 5: Создание BPMN и документации
1. На основе Pipeline и RACI
2. Следовать методологии из `30_bpmn_methodology.mdc` (Этап 4: BPMN)
3. Создать файл `[базовое_имя].bpmn` (только XML, без PDF)
4. Создать файл `[базовое_имя].md` (документация)
5. Валидировать BPMN в Camunda Modeler

### ШАГ 6: Автоматическая генерация DOCX копий

```bash
python3 scripts/utils/generate_docx.py output/[базовое_имя] [базовое_имя]
```

**Создаются:**
- `[базовое_имя]_OCR.docx`
- `[базовое_имя]_RACI.docx`
- `[базовое_имя]_Pipeline.docx` (с оглавлением)
- `[базовое_имя].docx` (с оглавлением)

**Почему DOCX, а не PDF:**
- Лучше обрабатывает сложные таблицы
- Автоматический перенос и подгонка ширины колонок
- Редактируемый формат
- Можно экспортировать в PDF из Word/LibreOffice

### ШАГ 7: Отчет пользователю

```markdown
ОБРАБОТКА ЗАВЕРШЕНА: [Название документа]

РЕКОМЕНДАЦИЯ: Переименуйте чат в "[базовое_имя]"

Созданные файлы в output/[базовое_имя]/:

MD файлы:
1. [базовое_имя]_OCR.md — расшифровка документа
2. [базовое_имя]_RACI.md — матрица ответственности
3. [базовое_имя]_Pipeline.md — текстовый пайплайн
4. [базовое_имя].md — документация процесса

BPMN:
5. [базовое_имя].bpmn — диаграмма процесса (XML)

DOCX копии (если pandoc установлен):
6-9. [базовое_имя]_OCR.docx, _RACI.docx, _Pipeline.docx, .docx

Статистика процесса:
- Количество страниц: X
- Количество ролей: Y
- Количество задач: Z
- Количество шлюзов: W

Выявленные проблемы: [список]
Рекомендации: [предложения]
Следующие шаги:
- Проверить BPMN в Camunda Modeler
- Уточнить неясные моменты
```

## КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО БЕЗ СОГЛАСОВАНИЯ:

- Создавать УПРОЩЕННЫЕ версии документов
- Пропускать разделы или этапы анализа
- Создавать "демонстрационные" или "тестовые" версии
- Писать "требует детального анализа" — ДЕЛАТЬ детальный анализ!
- Ограничивать контекст или объем анализа
- Сокращать материалы "для экономии места"
- Писать "[будет дополнено]" или "[продолжение следует]"
- Останавливаться на "примерах" вместо полного описания
- У нас 1 миллион токенов, использовать полностью
- Pipeline: описывать ВСЕ задачи по 7 пунктам
- BPMN: создавать ВСЕ элементы с визуализацией
- ОБЯЗАТЕЛЬНО lanes в каждом SubProcess
