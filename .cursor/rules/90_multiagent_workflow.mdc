---
description: Multi-agent workflow (roles, handoff, governance, observability)
globs:
  - "**/*"
alwaysApply: true
---

# Мультиагентный workflow

## Роли и контур ответственности

- **Главный агент (Orchestrator)**: формирует план, распределяет задачи, синтезирует результаты, инициирует governance-гейты. **Кодинг запрещён.** Для исследования кодовой базы использует встроенный `explore` subagent. Профиль: `.cursor/agents/orchestrator.md`.
- Текущий ассистент действует как главный агент: правки кода — только через подагентов.
- **Subagents**: специализированные исполнители работают в своей зоне ответственности.
- **Человек**: утверждает архитектурные/алгоритмические решения и любые действия с высоким риском.

## Назначение зон

- **coder-pipeline**: реализация кода парсинга и OCR (`scripts/pdf_to_context/**`, `scripts/utils/*`). Стек: Python, PyMuPDF, pdfplumber, transformers, Pillow.
- **coder-graph-rag**: реализация графа знаний и RAG (`scripts/graph/**`, `scripts/rag/**`, `scripts/document_graph/**`). Стек: networkx, ChromaDB, Neo4j, spaCy, sentence-transformers.
- **coder-bpmn**: генерация BPMN XML и скрипты валидации (`output/**/*.bpmn`, `scripts/utils/check_bpmn*.sh`). Стек: XML/BPMN 2.0, Camunda Modeler.
- **analyst-raci**: анализ корпоративных документов, подготовка RACI и Pipeline. Методология строго AS-IS. Зона: `output/**/*_RACI.md`, `output/**/*_Pipeline.md`, `input*/*.pdf`.
- **reviewer**: code review + BPMN review, проверка архитектуры и безопасности.
- **validator**: фактическая проверка результатов (pytest, линтер, check_bpmn.sh, OCR quality).
- **capsule-builder**: формирование/обновление документации (`docs/**`, `Changelog.md`, `README.md`). **Ограничение проекта:** MD-файлы создаются ТОЛЬКО по явному запросу пользователя.

## Коммуникация с оркестратором (человек -> оркестратор)

- **Формат запроса**: Goal + ограничения + приоритет (если есть).
- **Ответ оркестратора**: краткий план, перечень исполнителей, governance-гейты и ожидаемые артефакты.
- **Handoff человеку**: финальный отчёт строго по шаблону Handoff.

## Handoff subagents -> оркестратор

- Все handoff subagent'ов адресуются **оркестратору**.
- Оркестратор анализирует handoff'ы, принимает решение о завершении.
- Решение о коммите принимает **оркестратор** по итогам ревью и (если применимо) валидации.

## Процесс (канонический цикл)

1. **Анализ** — сбор фактов и контекста (orchestrator + explore).
2. **Предложение** — архитектурное решение и план.
3. **Согласование** — явное подтверждение человеком.
4. **Реализация** — изменения по согласованному плану.
5. **Ревью** — проверка качества и рисков.
6. **Валидация** — проверка результатов (тесты, данные, BPMN).
7. **Документация** — обновление документации / контекстной капсулы (только по запросу).
8. **Handoff/Close** — отчёт и фиксация изменений.

## Handoff-шаблон (обязателен)

Используется всеми агентами как формат ответа:

**Handoff**
- **Goal**: цель и ограничения.
- **Changes**: что сделано (файлы/модули/логика).
- **Evidence**: тесты/проверки (или "не запускалось" с причиной).
- **OpenQuestions**: что осталось неясным.
- **NextOwner**: кто следующий (роль).
- **Risks**: 1-3 пункта.
- **DocumentScope**: какие документы/процессы затронуты.
- **BPMNImpact**: влияние на BPMN-генерацию (нет / прямое / косвенное).
- **OCR_GPU**: требования к GPU/OCR (нет / требуется GPU / требуется flash-attn).
- **DataSensitivity**: конфиденциальность данных (публичный / внутренний / конфиденциальный).
- **BackwardCompatibility**: обратная совместимость (сохранена / feature flag / breaking change).

## Тесты и проверки

- **Валидатор** — владелец проверок и фиксации результатов.
- **Кодер** запускает тесты только по явному запросу.
- Если тесты невозможны — в `Evidence` фиксировать причину.
- **Orchestrator не запускает тесты/валидации напрямую** — только через subagents.

## Observability и аудит

### Логирование reasoning-шагов
- Каждый агент фиксирует ключевые reasoning-шаги в Handoff-артефакте: какие гипотезы рассматривались, какие отвергнуты и почему.

### Трассировка решений
- Поток от исходной цели до конкретных действий должен быть восстанавливаемым: Orchestrator фиксирует в Handoff цепочку «цель -> задача -> агент -> результат».

### Аудит действий
- Все изменения логируются через Handoff-шаблон (поля Changes и Evidence).
- При подозрении на аномальное поведение агента — эскалация человеку.

### Борьба с дрейфом контекста
- При длительных задачах (>3 последовательных вызовов агентов) Orchestrator выполняет «контрольную точку»: сверка текущего состояния с исходной целью.
- Если агент «топчется на месте» (повторяет действия без прогресса) — остановка и эскалация человеку.

## Governance-гейты

Требуют явного подтверждения человека:

- Архитектурные решения (новые модули, изменение пайплайна)
- Изменения GPU/OCR конфигурации (flash-attn, модели, Docker)
- Удаление файлов/модулей
- Изменение структуры output (шаблоны документов)
- Новые зависимости (requirements.txt)
- Изменения BPMN-методологии (правила моделирования)
- Работа с конфиденциальными документами (input2/, output2/)
- Новые публичные API
- Изменения CI/CD и деплоя

## Паттерны координации

### Механизм переключения агентов

Orchestrator явно вызывает агентов через Task tool. Каждый агент — stateless.

**Цикл взаимодействия:**
1. Orchestrator вызывает агента через Task tool.
2. Агент выполняет задачу.
3. Агент возвращает Handoff оркестратору.
4. Orchestrator решает, кого вызвать следующим.

### Sequential Pipeline (единственный допустимый паттерн)

- **Порядок:** Анализ (orchestrator + explore) -> Research/данные (analyst-raci) -> Реализация (coder-*) -> Ревью (reviewer) -> Валидация (validator) -> Документация (capsule-builder)
- **Один агент за раз**, строгий порядок. Следующий вызывается только после Handoff от предыдущего.
- Если на этапе Ревью выявлены замечания — возврат на Реализацию (итерация implement->review).

> **ЗАПРЕТ:** Параллельный запуск нескольких агентов-исполнителей не допускается.

### Лимит итераций и эскалация

- Максимум **3 итерации** цикла «Реализация -> Ревью» по одной задаче.
- При достижении лимита:
  1. Orchestrator **останавливает работу** над задачей.
  2. Формирует **отчёт для человека** по шаблону Handoff с полным описанием: что сделано, что не удалось, причины итераций, открытые вопросы.
  3. **Эскалация человеку** — дальнейшие действия определяет человек.
- Агент НЕ имеет права продолжать работу после достижения лимита.

## Разрешение конфликтов

Приоритеты при расхождении мнений агентов:

1. **Безопасность > Функциональность** — безопасный код важнее удобного.
2. **Источник истины (документ) > Предположения** — данные и правила важнее догадок агента.
3. **Человек > Orchestrator** — решения человека приоритетнее автоматических.
4. **Архитектурные правила > Удобство реализации** — соблюдение архитектуры важнее быстрого решения.
5. **AS-IS моделирование > Оптимизация** — точное отражение документа важнее «улучшений».

### При конфликте между агентами

- Reviewer выносит вердикт: «принять», «вернуть на доработку», «эскалировать человеку».
- При серьёзных расхождениях — эскалация человеку.
